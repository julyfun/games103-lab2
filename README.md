## 运行说明

甜甜圈的表示使用了 Package: `ProBuilder`。

- 拖动空白区域旋转镜头，W 或 S 前后移动镜头。
- 鼠标点击可以选中一个几何体，这个物体会呈现高亮，此时可以拖动物体，按下 `W, S` 可以绕 `X` 轴旋转，`A, D` 绕 `Y` 轴旋转，`Q, E` 绕 `Z` 轴旋转。
- 布料的大小可以在运行之前调节 `width_meter` 属性。几何体的大小可以在运行时调节拖动条（甜甜圈除外）。
- 风场的大小可以调节 `wind-zone` 对象的 `Main` 属性。其方向可以在场景中调节。

## 基本要求

### 1. 基于隐式积分的布料仿真 & 3. 隐式积分的 Chebyshev 加速 & Bonus 1. 仿真参数调节优化

`implicit_model.cs` 的 `update_force()`  
函数实现了切比雪夫加速收敛的牛顿迭代法。为了方便两种弹性计算模型的统一标示，`implicit_model` 和 `PBD_model` 继承自 `ClothModel`，并在 `ClothModel` 中实现对边和边长的初始化，以及碰撞、风力等通用函数。

同时考虑到各个模型使用的 `delta_t` 时间间隔是一样的，所以用 `GlobalVariable` 类存储通用变量，并赋给一个空对象曲线救国... 部分类中因此用 `access_to_global_variable()` 函数来同步全局变量。

`速度衰减系数`、`摩擦系数`、`弹性系数`、`结点质量`和`牛顿法迭代次数`可以通过滑动条在一定范围内修改，鼠标悬浮在参数上可以查看参数说明。  

### 2. 布料与球体间的碰撞处理 & Bonus 3. 通用 SDF 碰撞处理

`ClothModel` 基类中 `Collision_Handling()` 函数实现了布料与球体的碰撞处理。碰撞体均采用 SDF 表示法，这个函数给隐式积分子类和 PBD 子类复用。

有向距离场 SDF 是一种几何体表面的表示方法，即用空间中每个点距离其表面的最近距离来表示该几何体的表面（距离未负时表示在内部）。称这样一个有向距离场函数为 `sdf()`，则它的接口形式是 `float sdf(pos: Vector3)`。当 `sdf()` 接近 0 时，函数在该处梯度就是几何体表面在该处的法向量。梯度可以用极限的思想来求：

$$\dfrac{\partial f}{\partial x} \approx \dfrac{f(p + [h, 0, 0] ^ T) - f(p - [h, 0, 0] ^ T)}{2h}$$

`interface SdfInterface` 规范了派生这个接口的类必须实现 `sdf()` 函数。这个 `interface` 中的 `normal()` 函数会自动实现对 `sdf()` 函数求梯度。

那么应该怎么让所有的 `Sdf` 物体多可以拖拽移动呢？首先在 `SdfInterface` 中利用 `sdf()` 实现 `ray_march()` 和 `mouse_ray_hit()` 判断主相机到鼠标方向发出的光线是否与物体相交。其中 `ray_march()` 采用逐步法，让光线每次前进 `sdf()` 的距离，观察是否进入了物体内部，若进入则相交，否则继续前进 `sdf()` 的距离，超过一定步进次数则判断为不相交。然后创建 `SdfDraggable` 父类，他继承了 Unity 的 `MonoBahavior` 并派生 `SdfInterface` 接口，通过鼠标点击等状态量以及 `MonoBahavior` 的位置成员来移动每个物体的位置。这样，对于不同的几何体，只需要实现自己的 `sdf()` 函数，而不用关心自己是怎么被拖动和碰撞的。

代码里已经实现了球 (`SdfSphere`)，长方体 (`SdfCube`)，胶囊 (`SdfCapsule`) 和甜甜圈 (`SdfTorus`) 的类，除了甜甜圈都可以实时改变大小。为了视觉效果，实际碰撞体积比可视碰撞体积稍大，不然因为布料是基于 mesh 的，很容易出现穿模。

### 4. 基于PBD的布料仿真 & Bonus 2. 碰撞中的摩擦

`PDB_model.cs` 中的 `Strain_Limiting()` 函数实现了基于 `PDB` 的弹性约束。可以修改迭代次数 `num_iterations` 参数。

父类 `ClothModel` 的 `Collision_Handling()` 中处理碰撞时，利用 `SdfDraggable` 的鼠标拖动速度和 `mesh` 速度以及 `sdf()` 函数的梯度求得法向量和法向、切向速度，摩擦力效应仿照刚体碰撞中的切向衰减系数。

### 风场

添加了风场，可以修改 `wind-zone` 对象的风力大小，或在场景中旋转其方向，观察布料的运动捏，风力大小要调到 10 左右才明显。计算风场力是用每个 `mesh` 给点的法向量和风向的乘积算的。

## 思考

1. 几何体的表示方法：几何体在游戏中以 Scale 表示大小。代码中用可修改的变量维护一个与 Scale 等价的可视尺寸变量，为了防止穿模，实际碰撞尺寸变量略大于可视尺寸，这个可以用 C# 的 get 方法。
2. SDF 碰撞体不要求兼容各向异性的缩放可能是因为各向异性的缩放会导致同一点的 sdf 函数梯度变化。不过在 `SdfInterface` 代码中 `sdf()` 函数交给子类重写，缩放以后求导应该还是可以的。
3. 几何点旋转时，其上的点与布料碰撞时会产生额外速度，可用旋转矩阵和相对坐标写。
4. 现实材料如橡胶有很大的静摩擦力，尝试写了下，当切向速度衰减很大时设置变量 `locked[i]` 表示锁定布料上第 `i` 点与几何体的相对位置。但这个之前的刚体摩擦公式不兼容，写出来效果不是很好。也可以考虑在材料上抹一层胶水，布料贴紧材料后进入黏连状态，在一定范围内距离几何体越远就受到越大的拉力，一定距离后崩开。

## Reference 

1. 各个几何体的 `sdf()` 函数：https://iquilezles.org/articles/distfunctions/
